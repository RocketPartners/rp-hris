name: CD (Continuous Deployment)

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed

permissions:
  contents: read
  id-token: write # Required for OIDC authentication (if using AWS/GCP/Azure)

jobs:
  check-affected:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      web-affected: ${{ steps.check-web.outputs.affected }}
      api-affected: ${{ steps.check-api.outputs.affected }}
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if web was affected
        id: check-web
        run: |
          if npx nx show projects --affected --json | grep -q '"web"'; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "âœ… Web app was affected - will deploy"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Web app was NOT affected - skipping deployment"
          fi

      - name: Check if api was affected
        id: check-api
        run: |
          if npx nx show projects --affected --json | grep -q '"api"'; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "âœ… API was affected - will deploy"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ API was NOT affected - skipping deployment"
          fi

  deploy-web:
    needs: check-affected
    if: needs.check-affected.outputs.web-affected == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-web
      url: https://your-web-app.com # Update with your actual URL
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npx nx build web --configuration=production

      # Example: Deploy to Vercel
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          vercel --prod --token=$VERCEL_TOKEN --yes
        working-directory: dist/apps/web

      # Alternative: Deploy to AWS S3 + CloudFront
      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsRole
      #     aws-region: us-east-1

      # - name: Deploy to S3
      #   run: |
      #     aws s3 sync dist/apps/web s3://your-bucket-name --delete
      #     aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths "/*"

      # Alternative: Deploy to Netlify
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v2
      #   with:
      #     publish-dir: './dist/apps/web'
      #     production-branch: main
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  deploy-api:
    needs: check-affected
    if: needs.check-affected.outputs.api-affected == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-api
      url: https://api.your-domain.com # Update with your actual URL
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build API
        run: npx nx build api --configuration=production

      # Example: Deploy to Railway
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up --service api
        working-directory: dist/apps/api

      # Alternative: Deploy to AWS Elastic Beanstalk
      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsRole
      #     aws-region: us-east-1

      # - name: Deploy to Elastic Beanstalk
      #   run: |
      #     zip -r deploy.zip dist/apps/api
      #     aws elasticbeanstalk create-application-version \
      #       --application-name rp-hris-api \
      #       --version-label ${{ github.sha }} \
      #       --source-bundle S3Bucket="your-bucket",S3Key="deploy.zip"
      #     aws elasticbeanstalk update-environment \
      #       --application-name rp-hris-api \
      #       --environment-name production \
      #       --version-label ${{ github.sha }}

      # Alternative: Deploy to Render
      # - name: Deploy to Render
      #   env:
      #     RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      #     RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      #   run: |
      #     curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
      #       -H "Authorization: Bearer $RENDER_API_KEY" \
      #       -H "Content-Type: application/json" \
      #       -d '{"clearCache": "clear"}'

      # Alternative: Deploy to Heroku
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{secrets.HEROKU_API_KEY}}
      #     heroku_app_name: "your-api-app-name"
      #     heroku_email: "your-email@example.com"
      #     appdir: "dist/apps/api"

  deployment-summary:
    needs: [check-affected, deploy-web, deploy-api]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-affected.outputs.web-affected }}" == "true" ]; then
            if [ "${{ needs.deploy-web.result }}" == "success" ]; then
              echo "âœ… **Web App**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Web App**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Web App**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-affected.outputs.api-affected }}" == "true" ]; then
            if [ "${{ needs.deploy-api.result }}" == "success" ]; then
              echo "âœ… **API**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **API**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **API**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
